{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }} | Qicchu Блог</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 80px 0;
            color: white;
            margin-bottom: 40px;
        }
        .post-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .post-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .post-content {
            line-height: 1.8;
            font-size: 1.1rem;
        }
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
        }
        .post-meta {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }
        .author-badge {
            background-color: #e9ecef;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.9rem;
            display: inline-block;
        }
        .action-buttons {
            margin-top: 40px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .copy-btn {
            cursor: pointer;
            transition: all 0.3s;
        }
        .copy-btn:hover {
            transform: scale(1.1);
        }
        <!-- Добавьте этот стиль в блок <style> -->
        .comment {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .comment:hover {
            background-color: #e9ecef;
        }
        .comment-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .avatar {
            font-weight: bold;
        }

        .comment-card {
            border-left: 3px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .comment-card:hover {
            border-left-color: #0d6efd;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .children {
            border-left: 2px dashed #eee;
            padding-left: 15px;
        }
    </style>
</head>
<body>
    <!-- Герой-секция -->
    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-5 fw-bold">{{ post.title }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb justify-content-center">
                    <li class="breadcrumb-item"><a href="{% url 'blog:homepage' %} " class="text-white">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'blog:homepage' %}" class="text-white">Блог</a></li>
                    <li class="breadcrumb-item active text-light" aria-current="page">Пост</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Основное содержимое -->
    <div class="container post-container">
        <article>
            <div class="post-header text-center">
                <div class="d-flex justify-content-center align-items-center mb-3">
                    <span class="author-badge me-3">
                        <i class="bi bi-person-circle me-2"></i>{{ post.author }}
                    </span>
                    <small class="text-muted me-3">
                        <i class="bi bi-calendar me-1"></i>{{ post.publish }}
                    </small>
                    <small class="text-muted">
                        <i class="bi bi-bookmark me-1"></i>{{ post.category }}
                    </small>
                </div>
                {% if post.image %}
                <img src="{{ post.image.url }}" alt="{{ post.title }}" class="img-fluid rounded mb-4">
                {% endif %}
            </div>

            <div class="post-content position-relative">
                <button class="copy-btn btn btn-sm btn-outline-secondary position-absolute top-0 end-0"
                        onclick="copyToClipboard('post-content')"
                        title="Копировать текст">
                    <i class="bi bi-clipboard"></i>
                </button>

                <div id="post-content">
                    {{ post.content|safe}}
                </div>
                <!-- Добавьте этот блок сразу после </div> закрывающего тега post-content -->
                <div class="comments-section mt-5">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            {% with allcomments.count  as total_comments %}
                            <h4 class="mb-0"><i class="bi bi-chat-square-text me-2"></i>Комментарии ({{ total_comments }})</h4>
                            {% endwith %}
                        </div>
                    </div>
                <!-- Список комментариев -->
            <div class="comments-list mb-4">
                {% load mptt_tags %}

                <div class="comments-list">
        {% recursetree comments %}
            <div class="card mb-3 comment-card" style="margin-left: {% widthratio node.level 1 30 %}px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h6 class="card-subtitle mb-2 text-muted">User {{ node.name }}</h6>
                        <small class="text-muted">{{ node.publish|date:"d M Y H:i" }}</small>
                    </div>
                    <h6 class="card-subtitle mb-2 text-muted">{{ node.level }}</h6>
                    <h6 class="card-subtitle mb-2 text-muted">{{ node.id }}</h6>
                    <div id="{{ node.id }}"><p class="card-text">{{ node.content }}</p></div>

                    <!--  restricting limits of reply action -->
                    {% if node.level < 3 %}
                    <button class="btn btn-sm btn-outline-primary reply-btn"
                            data-comment-id="{{ node.id }}" onclick="myFunction({{ node.id }})">
                        Ответить
                    </button>
                    {% endif %}

                </div>

                {% if not node.is_leaf_node %}
                    <div class="children mt-3">
                        {{ children }}
                    </div>
                {% endif %}
            </div>
        {% endrecursetree %}
    </div>
<!-- </div> -->
      <div class="py-4">
          <nav aria-label="Page navigation example">
              {% if comments.has_other_pages %}
              <ul class="pagination justify-content-center">
                  <!-- кнопка Previous -->
                  {% if comments.has_previous %}
                  <li class="page-item"><a class="page-link" href="?page{{ comments.previous_page_number }}" aria-label="Previous">Previous
                  <span aria-hidden="true">&laquo;</span>
                      </a>
                  </li>
                    {% else %}
                  <li class="page-item disabled"><a href="#" class="page-link">Previous</a></li>
                  {% endif %}
                  {% for num in comments.paginator.page_range %}
                  {% if comments.number == 1 %}
                  <li class="page-item active"><span class="page-link">{{ num }} <span class="sr-only">(current)</span> </span></li>
                  {% else %}
                  <li><a href="?page={{ num }}">{{ num }}</a></li>
                  {% endif %}

                  {% endfor %}

                  {% if comments_has_text %}
                  <li class="page-item"><a class="page-link" href="?page={{ comments.next_page_number }}">Next</a></li>
                  {% else %}
                  <li class="page-item disabled"><a href="#" class="page-link">Next</a></li>
                  {% endif %}
              </ul>
              {% endif %}
          </nav>
      </div>

<!--                {% for comment in post.comments.all %} &ndash;&gt;-->
<!--                <div class="comment mb-3 d-flex">-->
<!--                    <div class="flex-shrink-0">-->
<!--                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"-->
<!--                             style="width: 40px; height: 40px;">-->
<!--                            {{ comment.name|first|upper }}-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="flex-grow-1 ms-3">-->
<!--                        <div class="d-flex justify-content-between align-items-center">-->
<!--                            <h6 class="mb-0">{{ comment.name }}</h6>-->
<!--                            <small class="text-muted">{{ comment.publish|date:"d M Y H:i" }}</small>-->
<!--                        </div>-->
<!--                            <p class="mb-0 mt-2">{{ comment.content }}</p>-->
<!--                    </div>-->
<!--                </div>-->
<!--                {% empty %}-->
<!--                <div class="text-center py-3 text-muted">-->
<!--                    Пока нет комментариев. Будьте первым!-->
<!--                </div>-->
<!--                {% endfor %}-->
<!--            </div>-->
                    <!-- Форма добавления комментария -->
            <div class="comment-form">
                <h5 class="mb-3">Оставить комментарий</h5>
                <form method="post">
                    {{ comment_form }}
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i> Отправить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
            <div class="post-meta">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="bi bi-tags me-2"></i>Теги:</h5>
                        <div class="tag-cloud">
                            {% for tag in post.tags.all %}
                            <a href="{% url 'blog:post_list_by_tag' tag.slug %}" class="btn btn-sm btn-outline-primary me-2 mb-2">
                                {{ tag.name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="bi bi-eye me-2"></i>Просмотры:</h5>
                        <p class="text-muted">1,245</p>
                    </div>
                </div>
            </div>
        </article>

        <div class="action-buttons d-flex justify-content-between">
            <a href="{% url 'blog:homepage' %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>Назад к списку
            </a>
            <div>
                <button class="btn btn-outline-secondary me-2" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Печать
                </button>
                <button class="btn btn-outline-success" onclick="sharePost()">
                    <i class="bi bi-share me-2"></i>Поделиться
                </button>
            </div>
        </div>
    </div>

    <!-- footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>© {% now "Y" %} Мой блог. Все права защищены.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // post text copy
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.innerText;

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.innerHTML = '<i class="bi bi-check2"></i>';
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
            });
        }

        // post share
        function sharePost() {
            if (navigator.share) {
                navigator.share({
                    title: '{{ post.title }}',
                    text: 'Посмотрите этот интересный пост:',
                    url: window.location.href
                }).catch(console.error);
            } else {
                alert('Скопируйте ссылку: ' + window.location.href);
            }
        }

        // function to close the reply form
        function formExit() {
            document.getElementById("newForm").remove();
        }

        // comment reply function
        function myFunction(id) {

            if (document.contains(document.getElementById("newForm"))) {
                document.getElementById("newForm").remove();
            }

            var a = document.getElementById(id);
            a.insertAdjacentHTML('afterend',
                '<form id="newForm" class="form-insert py-2" method="post"> \
                <div class="d-flex justify-content-between"><h2>Reply:</h2><div><button type="button" class="btn btn-outline-secondary" onclick="formExit({{ node.id }})"">Close</button></div></div> \
                <label for="id_name">Name:</label> \
                <input type="text" name="name" class="col-sm-12" maxlength="50" required="" id="id_name">\
                <select name="parent" class="d-none" id="id_parentt"> \
                <option value="' + id + '" selected="' + id + '"></option> \
                </select> \
                <label for="id_email">Email:</label> \
                <input type="text" name="email" class="col-sm-12" maxlength="254" required="" id="id_email"> \
                <label for="id_content">Content:</label> \
                <textarea name="content" cols="40" rows="5" class="form-control" required id="id_content"></textarea> \
                {% csrf_token %} \
                <button type="submit" class="btn btn-primary btn-lg">Отправить</button> \
              </form>'
            );
        }


    </script>
</body>
</html>